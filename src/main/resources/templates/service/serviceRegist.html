<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>serviceRegist</title>

    <!-- include libraries(jQuery, bootstrap) -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- include summernote css/js -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
</head>
<body>
<h2>글 등록</h2>
<div>
    <!-- 다 입력을 한 후에 /market/serviceSave URL로 값들을 다 보낸다. -->
    <form id="serviceRegistForm" th:action="@{/market/serviceSave}" th:method="post">
        <div>제목 : </div>
        <input type="text" th:name="title"> <br/>

        <div class="type">유형 : </div>
        <input type="radio" th:name="type" th:value="0">구매
        <input type="radio" th:name="type" th:value="1">판매<br/>

        <div class="textarea">내용 : </div>
        <textarea th:name="content" id="summernote" cols="30" rows="10"></textarea><br/>

        <div>가격 : </div>
        <input type="checkbox" th:name="price" th:value="0">무료
        <input type="text" th:name="price"><br/>

        <div>카테고리 : 1개 이상 선택하세요.</div>
        <div class="category">
            <input type="checkbox" id="취미" name="category" value="취미">취미
            <input type="checkbox" id="디지털" name="category" value="디지털">디지털
            <input type="checkbox" id="가전제품" name="category" value="가전제품">가전제품
            <input type="checkbox" id="반려동물" name="category" value="반려동물">반려동물
            <input type="checkbox" id="유아" name="category" value="유아">유아
            <input type="checkbox" id="여행" name="category" value="여행">여행
            <input type="checkbox" id="음식" name="category" value="음식">음식
            <input type="checkbox" id="생활용품" name="category" value="생활용품">생활용품
            <input type="checkbox" id="뷰티" name="category" value="뷰티">뷰티
            <input type="checkbox" id="패션잡화" name="category" value="패션잡화">패션잡화
            <input type="checkbox" id="스포츠" name="category" value="스포츠">스포츠
            <input type="checkbox" id="공부" name="category" value="공부">공부
        </div>

        <!-- value="I" 신규등록 구분하기 위해서 -->
        <input type="hidden" name="gubun" value="I" />
        <input type="submit" value="저장">
    </form>
</div>
<script>
    $('#summernote').summernote({
        height : 300, // 에디터 높이
        minHeight : null, // 최소 높이
        maxHeight : null, // 최대 높이
        focus : true, // 에디터 로딩후 포커스를 맞출지 여부
        lang : "ko-KR", // 한글 설정
        callbacks : {
            onImageUpload : function(files, editor, welEditable) {
                for (let i = files.length - 1; i >= 0; i--) {
                    uploadSummernoteImageFile(files[i], this);
                }
            }
        }
    });
    function uploadSummernoteImageFile(file, el) {
        data = new FormData();
        data.append('file', file);
        $.ajax({
            data : data,
            type : 'POST',
            url : '/uploadImage',
            contentType : false,
            enctype : 'multipart/form-data',
            processData : false,
            success : function(data) {
                $(el).summernote('editor.insertImage', data.url);
            }
        });
    }

    $(function() {

        $("#serviceRegistForm").submit(function() {
            // 유효성 검사 다 완료되서 끝날때까지 넘어가지 않게 멈추는거
            event.preventDefault();

            // id가 serviceRegistForm인 form을 불러온다.
            var form = $('#serviceRegistForm')[0];

            //					1. 무료 체크박스를 누르면 0이 전달된다.
            //					2. 체크박스를 누르지않고 가격을 입력하면 입력한 가격이 전달된다.
            //					3. 체크박스 누르면 텍스트타입 비활성화
            //					4. 텍스트타입 가격 입력하면 무료 체크박스가 비활성화
            //					price는 int타입이라서 무료 체크박스 누르면 0이 전달되어야 함.
            //					만약 체크박스를 누르면 숫자로 0이 전달
            //					free = parsnInt(free);
            //					if(form.price.value == 0) {

            //					체크박스를 선택하지않고 가격을 입력하면 그 가격 그대로 넘어가게
            //					} else {
            //					}

            // form 안에 type 유효성 체크
            // 					if (form.type.value == "") {
            // 						alert("음식이름은 필수 입력 항목입니다!");
            // 						$(form.type).focus();
            // 						return;
            // 					}

            // form 안에 title 유효성 체크
            // 					if (form.title.value == "") {
            // 						alert("가게이름은 필수 입력 항목입니다!");
            // 						$(form.title).focus();
            // 						return;
            // 					}

            // form 안에 content 유효성 체크
            // 					if (form.content.value == "") {
            // 						alert("음식 종류는 필수 입력 항목입니다!");
            // 						$(form.content).focus();
            // 						return;
            // 					}

            // form 안에 price 유효성 체크
            // 					if (form.price.value == "") {
            // 						alert("음식이름은 필수 입력 항목입니다!");
            // 						$(form.price).focus();
            // 						return;
            // 					}

            // form 안에 category 유효성 체크
            // 					if (form.category.value == "") {
            // 						alert("음식이름은 필수 입력 항목입니다!");
            // 						$(form.category).focus();
            // 						return;
            // 					}
            /**
             * url : 전송할 서버 주소
             * type : 전송방식 (get/post)
             * data : 전송할 데이터 ※ form.serialize() ? >> form 안에 데이터를 json 형태로 변환
             * success : 전송 후, 응답이 성공일 경우 수행할 기능 작성
             * error : 전송 후, 응답이 실패일 경우 수행할 기능 작성
             */
            var formData = new FormData(form);

            /* 					var categorys = [];
                                $("input[name = 'category'] : checked").each(function() {
                                    categorys.push($(this).val());

                                });
                                  */
            /*
                    $("input[name=category]:checked").each(function() {
                        var categorys = $(this).val();
                    }); */

            $.ajax({
                url : "/market/serviceSave",
                type : "post",
                data : formData,
                success : function(data) {

                    alert("정상적으로 저장되었습니다.");
                    // 처리가 완료되면 marketList로 이동한다.
                    location.href = "/market/marketListPage";

                },
                error : function(xhr, status) {
                    alert("오류가 발생했습니다. :: " + status);
                },
                cache : false,
                contentType : false,
                processData : false
            });
        });
    });
</script>
</body>
</html>