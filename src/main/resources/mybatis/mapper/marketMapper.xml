<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="market">

	<insert id="insertService" parameterType="MarketVO">
	<![CDATA[
		INSERT
		INTO MARKET
		(
			TYPE
		, TITLE
		, CONTENT
		, REG_DATE
		, JM_STATE
		, PRICE
		, ID
		, CATEGORY
		, RV_STATE
		, CH_STATE
		, SV_STATE
		)
		VALUES (
				   #{type}
			   , #{title}
			   , #{content}
			   , NOW()
			   , #{jmState}
			   , #{price}
			   , #{id}
			   , #{category}
			   , #{rvState}
			   , #{chState}
			   , #{svState}
			   )
		]]>
	</insert>

	<select id="selectMarketList" parameterType="MarketVO" resultType="MarketVO">
	<![CDATA[
		SELECT S.SERVICE_NO
			 , CASE S.TYPE
				   WHEN 0 THEN '구매'
				   WHEN 1 THEN '판매'
			END AS TYPE_NM
			 , S.TITLE
			 , S.CONTENT
			 , S.REG_DATE
			 , S.UPDATE_DATE
			 , S.JM_STATE
			 , S.PRICE
			 , S.ID
			 , J.JM_ID
			 , S.CATEGORY
			 , S.RV_STATE
			 , S.CH_STATE
			 , S.SV_STATE
		FROM MARKET S
				 LEFT OUTER JOIN JMSTATE J
								 ON S.ID = J.JM_ID
									 AND S.SERVICE_NO = J.JM_SERVICE
		]]>
	</select>

	<select id="selectServiceDetail" parameterType="MarketVO" resultType="MarketVO">
		<![CDATA[
		SELECT S.SERVICE_NO
			 , CASE S.TYPE
				   WHEN 0 THEN '구매'
				   WHEN 1 THEN '판매'
			END AS TYPE_NM
			 , S.TITLE
			 , S.CONTENT
			 , S.REG_DATE
			 , S.UPDATE_DATE
			 , M.LOCATION
			 , S.JM_STATE
			 , S.PRICE
			 , S.ID
			 , M.NICKNAME
			 , S.CATEGORY
			 , S.RV_STATE
			 , S.CH_STATE
			 , S.SV_STATE
		FROM MARKET S
				 INNER JOIN MEMBER M
							ON S.ID = M.ID
		WHERE SERVICE_NO = #{serviceNo}
		]]>
	</select>

	<update id="serviceUpdate" parameterType="MarketVO">
		UPDATE MARKET
		SET TYPE = #{type}
		  , TITLE = #{title}
		  , CONTENT = #{content}
		  , JM_STATE = #{jmState}
		  , PRICE = #{price}
		  , CATEGORY = #{category}
		  , RV_STATE = #{rvState}
		  , CH_STATE = #{chState}
		  , SV_STATE = #{svState}
		  , UPDATE_DATE = NOW()
		WHERE SERVICE_NO = #{serviceNo}
	</update>

	<delete id="serviceDelete" parameterType="MarketVO">
		DELETE
		FROM MARKET
		WHERE SERVICE_NO = #{serviceNo}
	</delete>

	<insert id="insertJm" parameterType="MarketVO">
	<![CDATA[
		INSERT
		INTO JMSTATE
		(
			JM_ID
		, JM_SERVICE
		)
		VALUES (
				   #{jmId}
			   , #{jmService}
			   )
		]]>
	</insert>

	<delete id="deleteJm" parameterType="MarketVO">
	<![CDATA[
		DELETE
		FROM JMSTATE
		WHERE JM_ID = #{jmId}
		  AND JM_SERVICE = #{jmService}
		]]>
	</delete>

	<update id="updateJmState" parameterType="MarketVO">
		UPDATE MARKET
		SET JM_STATE =
		<choose>
			<when test='gubun == "I"'>
				JM_STATE + 1
			</when>
			<when test='gubun == "D"'>
				JM_STATE - 1
			</when>
		</choose>
		WHERE SERVICE_NO = #{jmService}
	</update>
</mapper>